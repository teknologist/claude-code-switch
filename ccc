#!/usr/bin/env bash
set -euo pipefail

# Claude Code Commander (ccc)
# Repo-local launcher: switch model via ccm.sh and then exec `claude`
# This affects only the spawned `claude` process, not your parent shell.

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]:-$0}")" && pwd)"
CCM_CMD_DEFAULT="$SCRIPT_DIR/ccm.sh"
CCM="${CCM_CMD:-$CCM_CMD_DEFAULT}"

usage() {
    cat <<EOF
Usage: ./ccc <model> [claude-options]
       ./ccc <account> [claude-options]        # Switch account then launch (default model)
       ./ccc <model>:<account> [claude-options]

Examples:
  ./ccc deepseek                     # Launch Claude Code with DeepSeek
  ./ccc glm                          # Launch with GLM 4.6
  ./ccc kimi --dangerously-skip-permissions  # Pass options to Claude Code
  ./ccc woohelps                     # Switch to 'woohelps' account and launch
  ./ccc opus:work                    # Switch to 'work' account and use Opus

Available models:
  deepseek, glm, kimi, qwen, seed|doubao, claude, opus, haiku, longcat, minimax
  Account:  <account> | claude:<account> | opus:<account> | haiku:<account>
EOF
}

if [[ ! -f "$CCM" ]]; then
    echo "ccc error: cannot find ccm CLI at $CCM" >&2
    echo "Hint: ensure ccm.sh exists next to this script, or set CCM_CMD=/path/to/ccm.sh" >&2
    exit 1
fi

if [[ $# -lt 1 ]]; then
    usage
    exit 1
fi

model="$1"
shift || true

# Remaining args are passed through to `claude`
claude_args=("$@")

# Helper: is known model keyword
is_known_model() {
    case "$1" in
        deepseek|ds|glm|glm4|glm4.6|kimi|kimi2|qwen|longcat|lc|minimax|mm|seed|doubao|claude|sonnet|s|opus|o|haiku|h)
            return 0 ;;
        *)
            return 1 ;;
    esac
}

# Account-only mode: `ccc <account>` (not known model, no colon)
if [[ "$model" != *:* ]] && ! is_known_model "$model" && [[ ! "$model" =~ ^- ]]; then
    account="$model"
    # 1) Switch account directly (no eval)
    if ! "$CCM" switch-account "$account"; then
        echo "âŒ Failed to switch account: $account" >&2
        exit 1
    fi
    # Show current account summary (non-fatal if it fails)
    "$CCM" current-account || true
    # 2) Optionally set default model environment (Claude Sonnet)
    eval "$("$CCM" claude)"
else
    # Configure environment for this process using repo-local ccm
    eval "$("$CCM" "$model")"
fi

# Friendly status
echo ""
echo "ðŸš€ Launching Claude Code..."
echo "   Model: ${ANTHROPIC_MODEL:-'(unset)'}"
echo "   Base URL: ${ANTHROPIC_BASE_URL:-'Default (Anthropic)'}"

# Ensure `claude` is available
if ! command -v claude >/dev/null 2>&1; then
    echo "âŒ 'claude' CLI not found. Install it first: npm install -g @anthropic-ai/claude-code" >&2
    exit 127
fi

# Exec into Claude Code with the configured environment
if [[ ${#claude_args[@]} -eq 0 ]]; then
    exec claude
else
    exec claude "${claude_args[@]}"
fi
